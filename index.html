<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estante Personalizada com Backup</title>
    <style>
        body { margin: 0; padding: 0; background-color: transparent; font-family: 'Segoe UI', sans-serif; color: white; overflow-x: hidden; }
        .furniture-wrapper { width: 95%; max-width: 450px; margin: 20px auto; display: flex; flex-direction: column; align-items: center; }
        .bookshelf-container { width: 100%; background-color: #0d0d0d; border: 15px solid #1a1a1a; border-bottom: none; border-radius: 6px 6px 0 0; box-shadow: 10px 10px 30px rgba(0,0,0,0.8); display: flex; flex-direction: column; position: relative; }
        .shelf-row { height: 130px; border-bottom: 12px solid #252525; display: flex; align-items: flex-end; padding: 0 8px; background: linear-gradient(to bottom, #050505, #121212); position: relative; overflow: hidden; justify-content: flex-start; }
        .shelf-footer { width: 100%; display: flex; justify-content: space-between; padding: 0 5px; box-sizing: border-box; }
        .foot { width: 50px; height: 30px; background: #1a1a1a; border-radius: 0 0 5px 5px; position: relative; }
        #secret-btn { width: 100%; height: 100%; opacity: 0; cursor: pointer; border: none; }
        
        /* ESTILO DO LIVRO */
        .book { margin-right: 1px; background-size: cover; background-position: center; border-radius: 1px; box-shadow: 2px 0 5px rgba(0,0,0,0.9); transition: transform 0.2s; position: relative; z-index: 5; cursor: pointer; flex-shrink: 0; }
        .book:hover { transform: scale(1.05) translateY(-5px); z-index: 10; }
        .book:hover::after { content: attr(data-title); position: absolute; bottom: 105%; left: 50%; transform: translateX(-50%); background: #000; color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 11px; white-space: nowrap; z-index: 20; border: 1px solid #333; }
        
        /* PAINEL ADMINISTRATIVO */
        #admin-panel { display: none; background: #151515; padding: 15px; border-bottom: 2px solid #333; position: fixed; top: 0; left: 0; right: 0; z-index: 100; max-height: 85vh; overflow-y: auto; }
        .input-group { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 8px; }
        input { padding: 8px; background: #222; border: 1px solid #444; color: #eee; border-radius: 4px; font-size: 12px; }
        button.action-btn { padding: 8px 10px; cursor: pointer; border: none; border-radius: 4px; font-weight: 600; font-size: 10px; color: white; text-transform: uppercase; }
        .btn-add { background-color: #388E3C; }
        .btn-close { background-color: #555; }
        
        .backup-section { margin-top: 15px; padding-top: 10px; border-top: 1px dashed #444; display: flex; gap: 8px; }
        .btn-download { background-color: #2196F3; flex: 1; }
        .btn-load { background-color: #FF9800; flex: 1; }
        
        .list-item { display: flex; justify-content: space-between; align-items: center; background: #1f1f1f; padding: 6px 10px; margin-bottom: 4px; border-radius: 4px; border: 1px solid #333; font-size: 12px; }
        .btn-trash { background: #D32F2F; color: white; border: none; border-radius: 4px; width: 24px; height: 24px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="admin-panel">
        <h3 style="margin: 0 0 10px 0; color: #ccc;">Painel da Estante</h3>
        
        <div class="input-group">
            <input type="text" id="seriesName" placeholder="T√≠tulo" style="flex: 2;">
            <input type="number" id="volNumber" placeholder="Vol." style="width: 50px;">
            <input type="number" id="spineWidth" placeholder="Largura (ex: 2.5)" step="0.1" style="width: 100px;">
        </div>
        <div class="input-group">
            <input type="text" id="imgUrl" placeholder="URL da Imagem" style="flex: 1;">
            <input type="text" id="pageLink" placeholder="Link Notion (opcional)" style="flex: 1;">
            <button class="action-btn btn-add" onclick="addBook()">Adicionar</button>
            <button class="action-btn btn-close" onclick="togglePanel()">Sair</button>
        </div>

        <div class="backup-section">
            <button class="action-btn btn-download" onclick="downloadBackup()">üíæ BAIXAR BACKUP</button>
            <button class="action-btn btn-load" onclick="document.getElementById('fileInput').click()">üìÇ CARREGAR BACKUP</button>
            <input type="file" id="fileInput" style="display:none" onchange="loadBackupFromFile(event)">
        </div>

        <div id="active-book-list" style="margin-top:15px;"></div>
    </div>

    <div class="furniture-wrapper">
        <div class="bookshelf-container" id="bookshelf">
            <div class="shelf-row" id="shelf-1"></div>
            <div class="shelf-row" id="shelf-2"></div>
            <div class="shelf-row" id="shelf-3"></div>
            <div class="shelf-row" id="shelf-4"></div>
            <div class="shelf-row" id="shelf-5"></div>
            <div class="shelf-row" id="shelf-6"></div>
        </div>
        <div class="shelf-footer">
            <div class="foot"></div>
            <div class="foot"><button id="secret-btn" onclick="togglePanel()"></button></div>
        </div>
    </div>

    <script>
        const MAIN_KEY = 'myMangaShelf_FINAL';
        const RESCUE_KEYS = ['myMangaShelf_v12', 'myMangaShelf_v11', 'myMangaShelf_v10', 'myMangaShelf_v7'];

        function loadData() {
            let current = localStorage.getItem(MAIN_KEY);
            if (current && JSON.parse(current).length > 0) return JSON.parse(current);
            for (let oldKey of RESCUE_KEYS) {
                let found = localStorage.getItem(oldKey);
                if (found) return JSON.parse(found);
            }
            return [];
        }

        let localBooks = loadData();

        function togglePanel() {
            const panel = document.getElementById('admin-panel');
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
            renderBookList(); 
        }

        function addBook() {
            const series = document.getElementById('seriesName').value.trim();
            const vol = parseInt(document.getElementById('volNumber').value) || 0;
            const widthCm = parseFloat(document.getElementById('spineWidth').value) || 2.5; // Padr√£o 2.5cm
            const url = document.getElementById('imgUrl').value.trim();
            const link = document.getElementById('pageLink').value.trim();
            
            if (!series || !url) return alert("T√≠tulo e Imagem s√£o obrigat√≥rios!");

            // Convertemos CM para pixels para a exibi√ß√£o (aproximadamente 1cm = 10px na nossa escala)
            const widthPx = widthCm * 10;

            localBooks.push({ series, vol, url, link, h: 90, w: widthPx, id: Date.now() });
            save();
            
            // Limpa campos para o pr√≥ximo
            document.getElementById('volNumber').value = '';
            document.getElementById('imgUrl').value = '';
        }

        function save() {
            localStorage.setItem(MAIN_KEY, JSON.stringify(localBooks));
            renderShelf();
            renderBookList();
        }

        function deleteBook(id) {
            if(confirm("Excluir volume?")) {
                localBooks = localBooks.filter(b => b.id !== id);
                save();
            }
        }

        function downloadBackup() {
            const dataStr = JSON.stringify(localBooks, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = "meus_mangas_backup.json";
            link.click();
            URL.revokeObjectURL(url);
        }

        function loadBackupFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (Array.isArray(imported)) {
                        if (confirm("Isso vai substituir sua estante atual. Continuar?")) {
                            localBooks = imported;
                            save();
                            alert("Backup carregado!");
                        }
                    }
                } catch (err) { alert("Arquivo inv√°lido."); }
            };
            reader.readAsText(file);
        }

        function renderBookList() {
            const list = document.getElementById('active-book-list');
            list.innerHTML = '';
            localBooks.sort((a,b) => a.series.localeCompare(b.series) || a.vol - b.vol);
            localBooks.forEach(b => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `<span>${b.series} #${b.vol} (${(b.w/10).toFixed(1)}cm)</span><button class="btn-trash" onclick="deleteBook(${b.id})">üóëÔ∏è</button>`;
                list.appendChild(item);
            });
        }

        function renderShelf() {
            for (let i = 1; i <= 6; i++) document.getElementById(`shelf-${i}`).innerHTML = '';
            localBooks.sort((a,b) => a.series.localeCompare(b.series) || a.vol - b.vol);
            
            let shelfIdx = 1; 
            let currentW = 0;
            const MAX_SHELF_W = 380; // Largura m√°xima da prateleira em "pixels"

            localBooks.forEach(b => {
                // Se o livro n√£o couber na prateleira atual, pula para a pr√≥xima
                if (currentW + b.w > MAX_SHELF_W) { 
                    shelfIdx++; 
                    currentW = 0; 
                }
                
                const shelf = document.getElementById(`shelf-${shelfIdx}`);
                if (shelf) {
                    const div = document.createElement('div');
                    div.className = 'book';
                    div.style.backgroundImage = `url('${b.url}')`;
                    div.style.height = `${b.h}%`;
                    div.style.width = `${b.w}px`; // Usa a largura salva (convertida de cm)
                    div.setAttribute('data-title', `${b.series} #${b.vol}`);
                    if (b.link) div.onclick = () => window.open(b.link, '_blank');
                    shelf.appendChild(div);
                    currentW += b.w;
                }
            });
        }

        renderShelf();
    </script>
</body>
</html>
