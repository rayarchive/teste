<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Estante Widget - Mobile Ultra Fix</title>
    <style>
        body {
            margin: 0; padding: 0;
            background-color: transparent; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white;
            -webkit-tap-highlight-color: transparent;
        }

        .furniture-wrapper {
            width: 95%; max-width: 420px;
            margin: 20px auto;
            display: flex; flex-direction: column; align-items: center;
        }

        .bookshelf-container {
            width: 100%;
            background-color: #0d0d0d; 
            border: 15px solid #1a1a1a; 
            border-bottom: none;
            border-radius: 6px 6px 0 0; 
            box-shadow: 10px 10px 30px rgba(0,0,0,0.6);
            display: flex; flex-direction: column;
            position: relative;
        }

        .shelf-row {
            height: 130px; 
            border-bottom: 12px solid #252525;
            display: flex; align-items: flex-end; 
            padding: 0 8px;
            background: linear-gradient(to bottom, #050505, #161616); 
            position: relative;
            overflow: hidden; 
        }

        /* BASE E BOTÃO SECRETO */
        .shelf-footer { width: 100%; display: flex; justify-content: space-between; padding: 0 5px; box-sizing: border-box; }
        .foot { width: 50px; height: 30px; background: #1a1a1a; border-radius: 0 0 5px 5px; }
        #secret-btn { width: 100%; height: 100%; opacity: 0; cursor: pointer; border: none; }
        
        /* LOMBADAS - AJUSTE MOBILE */
        .book-item {
            margin-right: 1px;
            background-size: 100% 100%; /* Força preenchimento total */
            background-position: center;
            background-repeat: no-repeat;
            border-radius: 1px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.9);
            transition: transform 0.2s;
            position: relative;
            flex-shrink: 0; 
            display: block;
            text-decoration: none;
        }

        .book-item:active { transform: scale(0.95); } /* Feedback de toque no celular */

        .book-item:hover::after {
            content: attr(data-title);
            position: absolute; bottom: 105%; left: 50%;
            transform: translateX(-50%);
            background: #000; color: #fff;
            padding: 4px 8px; border-radius: 4px;
            font-size: 11px; white-space: nowrap;
            z-index: 20; border: 1px solid #333;
        }

        /* PAINEL */
        #admin-panel {
            display: none; background: #151515; padding: 15px;
            border-bottom: 2px solid #333; position: fixed;
            top: 0; left: 0; right: 0; z-index: 100;
            max-height: 90vh; overflow-y: auto; 
            box-shadow: 0 10px 40px rgba(0,0,0,1);
        }

        .input-group { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; }
        input { padding: 8px; background: #222; border: 1px solid #444; color: #eee; border-radius: 4px; font-size: 14px; }
        
        button.action-btn { padding: 10px; cursor: pointer; border: none; border-radius: 4px; font-weight: 600; text-transform: uppercase; font-size: 11px; color: white; }
        .btn-add { background-color: #388E3C; }
        .btn-close { background-color: #D32F2F; }
        .btn-gen { background-color: #2196F3; width: 100%; margin-top: 8px; }
        .btn-load { background-color: #FF9800; width: 100%; margin-top: 8px; }

        .list-item { display: flex; justify-content: space-between; align-items: center; background: #1f1f1f; padding: 8px; margin-bottom: 5px; border-radius: 4px; border: 1px solid #333; }
        .btn-trash { background: #b71c1c; color: white; border: none; border-radius: 3px; width: 30px; height: 30px; cursor: pointer; }

        textarea { width: 100%; height: 80px; background: #111; color: #0f0; font-family: monospace; font-size: 12px; border: 1px solid #333; margin-top: 8px; padding: 8px; box-sizing: border-box; }
        #status-msg { margin: 10px 0; padding: 10px; border-radius: 4px; display: none; text-align: center; font-weight: bold; }
        .status-success { background: #1b5e20; }
        .status-error { background: #b71c1c; }
    </style>
</head>
<body>

    <div id="admin-panel">
        <h3 style="margin: 0 0 10px 0; color: #ccc;">Painel Administrativo</h3>
        <div id="status-msg"></div>

        <div class="input-group">
            <input type="text" id="seriesName" placeholder="Título" style="flex: 2;">
            <input type="number" id="volNumber" placeholder="Vol." style="width: 60px;">
        </div>

        <div class="input-group">
            <input type="text" id="imgUrl" placeholder="Link da Imagem (Imgur)" style="flex: 2;">
            <input type="text" id="pageLink" placeholder="Link do Notion/Site" style="flex: 2;">
        </div>

        <div class="input-group">
            <input type="number" id="bookHeightCm" style="width: 80px;" placeholder="Alt cm" value="19" step="0.1">
            <input type="number" id="bookWidthCm" style="width: 80px;" placeholder="Esp cm" value="1.5" step="0.1">
            <button class="action-btn btn-add" onclick="addBook()">Salvar</button>
            <button class="action-btn btn-close" onclick="togglePanel()">Fechar</button>
        </div>

        <div id="book-list-container" style="margin-top: 15px; border-top: 1px solid #333;">
            <p style="font-size: 12px; color: #888;">Livros na estante:</p>
            <div id="active-book-list"></div>
        </div>

        <div style="margin-top: 20px; border-top: 1px dashed #444;">
            <textarea id="backupText" placeholder="Cole aqui para restaurar ou clique em gerar..."></textarea>
            <button class="action-btn btn-gen" onclick="generateBackupCode()">Gerar Código de Backup</button>
            <button class="action-btn btn-load" onclick="restoreBackupCode()">Restaurar via Código</button>
        </div>
    </div>

    <div class="furniture-wrapper">
        <div class="bookshelf-container" id="bookshelf">
            <div class="shelf-row" id="shelf-1"></div>
            <div class="shelf-row" id="shelf-2"></div>
            <div class="shelf-row" id="shelf-3"></div>
            <div class="shelf-row" id="shelf-4"></div>
            <div class="shelf-row" id="shelf-5"></div>
            <div class="shelf-row" id="shelf-6"></div>
        </div>
        <div class="shelf-footer">
            <div class="foot"></div>
            <div class="foot"><button id="secret-btn" onclick="togglePanel()"></button></div>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'myMangaShelf_Final_v1';
        let myBooks = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        const PIXELS_PER_CM = 5; 

        function showStatus(text, type) {
            const el = document.getElementById('status-msg');
            el.innerText = text;
            el.className = type === 'error' ? 'status-error' : 'status-success';
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 3000);
        }

        function togglePanel() {
            const panel = document.getElementById('admin-panel');
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
            renderBookList();
        }

        function saveAndRender() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(myBooks));
            renderShelf();
            renderBookList();
        }

        function addBook() {
            const series = document.getElementById('seriesName').value.trim();
            const vol = parseInt(document.getElementById('volNumber').value) || 0;
            let url = document.getElementById('imgUrl').value.trim();
            let link = document.getElementById('pageLink').value.trim();
            let h = parseFloat(document.getElementById('bookHeightCm').value) || 19;
            let w = parseFloat(document.getElementById('bookWidthCm').value) || 1.5;

            if (!series || !url) { showStatus("Título e Imagem obrigatórios!", "error"); return; }
            if (link && !link.startsWith('http')) link = 'https://' + link;

            myBooks.push({ series, vol, url, link, h_cm: h, w_cm: w, id: Date.now() });
            saveAndRender();
            showStatus("Adicionado!", "success");
        }

        function deleteBook(id) {
            myBooks = myBooks.filter(b => b.id !== id);
            saveAndRender();
        }

        function generateBackupCode() {
            const area = document.getElementById('backupText');
            area.value = JSON.stringify(myBooks);
            area.select();
            document.execCommand('copy');
            showStatus("Código copiado!", "success");
        }

        function restoreBackupCode() {
            try {
                const code = document.getElementById('backupText').value.trim();
                const data = JSON.parse(code);
                if (Array.isArray(data)) {
                    myBooks = data;
                    saveAndRender();
                    showStatus("Restaurado!", "success");
                }
            } catch (e) { showStatus("Código inválido!", "error"); }
        }

        function renderBookList() {
            const container = document.getElementById('active-book-list');
            container.innerHTML = '';
            myBooks.forEach(b => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `<span>${b.series} #${b.vol}</span><button class="btn-trash" onclick="deleteBook(${b.id})">X</button>`;
                container.appendChild(div);
            });
        }

        function renderShelf() {
            for (let i = 1; i <= 6; i++) document.getElementById(`shelf-${i}`).innerHTML = '';
            
            myBooks.sort((a,b) => a.series.localeCompare(b.series) || a.vol - b.vol);

            let sIdx = 1; let currentW = 0;
            myBooks.forEach(b => {
                const hPx = b.h_cm * PIXELS_PER_CM;
                const wPx = b.w_cm * PIXELS_PER_CM;
                
                const el = document.createElement(b.link ? 'a' : 'div');
                el.className = 'book-item';
                if(b.link) { el.href = b.link; el.target = '_blank'; }
                
                // O TRUQUE: Adicionamos um parâmetro aleatório no final da URL da imagem
                // Isso força o navegador do celular a baixar a imagem de novo se ela falhar.
                const antiCacheUrl = b.url + (b.url.includes('?') ? '&' : '?') + 't=' + b.id;
                
                el.style.backgroundImage = `url('${antiCacheUrl}')`;
                el.style.height = `${hPx}px`;
                el.style.width = `${wPx}px`;
                el.setAttribute('data-title', `${b.series} #${b.vol}`);

                if (currentW + wPx > 390) { sIdx++; currentW = 0; }
                const shelf = document.getElementById(`shelf-${sIdx}`);
                if (shelf) { shelf.appendChild(el); currentW += wPx + 1; }
            });
        }

        renderShelf();
    </script>
</body>
</html>
