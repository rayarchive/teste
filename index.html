<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estante Completa (CM + Backup)</title>
    <style>
        body { margin: 0; padding: 0; background-color: transparent; font-family: 'Segoe UI', sans-serif; color: white; overflow-x: hidden; }
        .furniture-wrapper { width: 90%; max-width: 420px; margin: 20px auto; display: flex; flex-direction: column; align-items: center; }
        .bookshelf-container { width: 100%; background-color: #0d0d0d; border: 15px solid #1a1a1a; border-bottom: none; border-radius: 6px 6px 0 0; box-shadow: 10px 10px 30px rgba(0,0,0,0.8); display: flex; flex-direction: column; position: relative; }
        .shelf-row { height: 130px; border-bottom: 12px solid #252525; display: flex; align-items: flex-end; padding: 0 8px; background: linear-gradient(to bottom, #050505, #121212); position: relative; overflow: hidden; justify-content: flex-start; }
        .shelf-footer { width: 100%; display: flex; justify-content: space-between; padding: 0 5px; box-sizing: border-box; }
        .foot { width: 50px; height: 30px; background: #1a1a1a; border-radius: 0 0 5px 5px; position: relative; }
        #secret-btn { width: 100%; height: 100%; opacity: 0; cursor: pointer; border: none; }
        .book { margin-right: 1px; background-size: cover; background-position: center; border-radius: 1px; box-shadow: 2px 0 5px rgba(0,0,0,0.9); transition: transform 0.2s; position: relative; z-index: 5; cursor: pointer; }
        .book:hover { transform: scale(1.05) translateY(-5px); z-index: 10; }
        .book:hover::after { content: attr(data-title); position: absolute; bottom: 105%; left: 50%; transform: translateX(-50%); background: #000; color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 11px; white-space: nowrap; z-index: 20; border: 1px solid #333; }
        
        #admin-panel { display: none; background: #151515; padding: 15px; border-bottom: 2px solid #333; position: fixed; top: 0; left: 0; right: 0; z-index: 100; max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .input-group { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; }
        input { padding: 8px; background: #222; border: 1px solid #444; color: #eee; border-radius: 4px; font-size: 13px; }
        .input-cm { width: 80px; border: 1px solid #2196F3 !important; } /* Destaque azul para medidas */
        
        button.action-btn { padding: 8px 12px; cursor: pointer; border: none; border-radius: 4px; font-weight: 600; font-size: 10px; color: white; text-transform: uppercase; }
        .btn-add { background-color: #388E3C; }
        .btn-close { background-color: #555; }
        
        /* Bot√µes de Backup */
        .backup-section { margin-top: 15px; padding-top: 10px; border-top: 1px dashed #444; display: flex; gap: 10px; }
        .btn-download { background-color: #2196F3; flex: 1; }
        .btn-load { background-color: #FF9800; flex: 1; }
        
        .list-item { display: flex; justify-content: space-between; align-items: center; background: #1f1f1f; padding: 8px 12px; margin-bottom: 4px; border-radius: 4px; border: 1px solid #333; }
        .btn-trash { background: #D32F2F; color: white; border: none; border-radius: 4px; width: 28px; height: 28px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="admin-panel">
        <h3 style="margin: 0 0 10px 0; color: #ccc;">Painel (CM + Backup)</h3>
        
        <div class="input-group">
            <input type="text" id="seriesName" placeholder="T√≠tulo" style="flex:2">
            <input type="number" id="volNumber" placeholder="Vol." style="width: 50px;">
        </div>
        <div class="input-group">
            <input type="text" id="imgUrl" placeholder="Link Imagem" style="flex: 1;">
            <input type="text" id="pageLink" placeholder="Link Notion" style="flex: 1;">
        </div>
        
        <div class="input-group">
            <input type="number" id="bookHeightCm" class="input-cm" step="0.1" placeholder="Alt (cm)" value="21">
            <input type="number" id="bookWidthCm" class="input-cm" step="0.1" placeholder="Larg (cm)" value="1.5">
            <button class="action-btn btn-add" onclick="addBook()">Adicionar</button>
            <button class="action-btn btn-close" onclick="togglePanel()">Sair</button>
        </div>

        <div class="backup-section">
            <button class="action-btn btn-download" onclick="downloadBackup()">üíæ BAIXAR ARQUIVO DE BACKUP</button>
            <button class="action-btn btn-load" onclick="document.getElementById('fileInput').click()">üìÇ CARREGAR BACKUP</button>
            <input type="file" id="fileInput" style="display:none" onchange="loadBackupFromFile(event)">
        </div>

        <div id="book-list-container" style="margin-top:20px;">
            <div id="active-book-list"></div>
        </div>
    </div>

    <div class="furniture-wrapper">
        <div class="bookshelf-container" id="bookshelf">
            <div class="shelf-row" id="shelf-1"></div>
            <div class="shelf-row" id="shelf-2"></div>
            <div class="shelf-row" id="shelf-3"></div>
            <div class="shelf-row" id="shelf-4"></div>
            <div class="shelf-row" id="shelf-5"></div>
            <div class="shelf-row" id="shelf-6"></div>
        </div>
        <div class="shelf-footer">
            <div class="foot"></div>
            <div class="foot"><button id="secret-btn" onclick="togglePanel()"></button></div>
        </div>
    </div>

    <script>
        const MAIN_KEY = 'myMangaShelf_FINAL';
        // Rastreador de chaves antigas
        const RESCUE_KEYS = ['myMangaShelf_v12', 'myMangaShelf_v11', 'myMangaShelf_v10', 'myMangaShelf_v7'];

        function loadData() {
            let current = localStorage.getItem(MAIN_KEY);
            if (current && JSON.parse(current).length > 0) return JSON.parse(current);
            for (let oldKey of RESCUE_KEYS) {
                let found = localStorage.getItem(oldKey);
                if (found) return JSON.parse(found);
            }
            return [];
        }

        let localBooks = loadData();

        function togglePanel() {
            const panel = document.getElementById('admin-panel');
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
            renderBookList(); 
        }

        function addBook() {
            const series = document.getElementById('seriesName').value.trim();
            const vol = parseInt(document.getElementById('volNumber').value) || 0;
            const url = document.getElementById('imgUrl').value.trim();
            const link = document.getElementById('pageLink').value.trim();
            
            // L√≥gica de convers√£o CM -> Tela
            const hCm = parseFloat(document.getElementById('bookHeightCm').value);
            const wCm = parseFloat(document.getElementById('bookWidthCm').value);
            // C√°lculos ajustados para o CSS atual
            const calculatedH = (hCm * 90) / 21; // 21cm ocupa 90% da altura
            const calculatedW = wCm * 18;        // Fator de largura (ajuste se achar grosso/fino)

            if (!series || !url) return alert("T√≠tulo e Imagem s√£o obrigat√≥rios!");

            localBooks.push({ 
                series, vol, url, link, 
                h: calculatedH.toFixed(1), 
                w: calculatedW.toFixed(1), 
                id: Date.now() 
            });
            
            save();
            document.getElementById('volNumber').value = '';
            document.getElementById('imgUrl').value = '';
        }

        function save() {
            localStorage.setItem(MAIN_KEY, JSON.stringify(localBooks));
            renderShelf();
            renderBookList();
        }

        function deleteBook(id) {
            if(confirm("Excluir volume?")) {
                localBooks = localBooks.filter(b => b.id !== id);
                save();
            }
        }

        function downloadBackup() {
            const dataStr = JSON.stringify(localBooks, null, 2);
            try {
                // Tenta criar o arquivo para download
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = "meus_mangas_backup.json";
                link.click();
                URL.revokeObjectURL(url);
            } catch (err) {
                // Se falhar (alguns browsers mobile antigos), mostra texto
                prompt("Copie o c√≥digo abaixo e salve num bloco de notas:", dataStr);
            }
        }

        function loadBackupFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (Array.isArray(imported)) {
                        if (confirm("Isso vai substituir sua estante atual pelo backup. Continuar?")) {
                            localBooks = imported;
                            save();
                            alert("Backup carregado com sucesso!");
                        }
                    }
                } catch (err) { alert("Arquivo inv√°lido."); }
            };
            reader.readAsText(file);
        }

        function renderBookList() {
            const list = document.getElementById('active-book-list');
            list.innerHTML = '';
            localBooks.sort((a,b) => a.series.localeCompare(b.series) || a.vol - b.vol);
            localBooks.forEach(b => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `<span>${b.series} #${b.vol}</span><button class="btn-trash" onclick="deleteBook(${b.id})">üóëÔ∏è</button>`;
                list.appendChild(item);
            });
        }

        function renderShelf() {
            for (let i = 1; i <= 6; i++) document.getElementById(`shelf-${i}`).innerHTML = '';
            localBooks.sort((a,b) => a.series.localeCompare(b.series) || a.vol - b.vol);
            
            let shelfIdx = 1; 
            let currentW = 0;
            const shelfMaxW = 380;

            localBooks.forEach(b => {
                // Converte string para float caso venha do JSON
                let w = parseFloat(b.w);
                
                if (currentW + w > shelfMaxW) { shelfIdx++; currentW = 0; }
                
                const shelf = document.getElementById(`shelf-${shelfIdx}`);
                if (shelf) {
                    const div = document.createElement('div');
                    div.className = 'book';
                    div.style.backgroundImage = `url('${b.url}')`;
                    div.style.height = `${b.h}%`;
                    div.style.width = `${w}px`;
                    div.setAttribute('data-title', `${b.series} #${b.vol}`);
                    if (b.link) div.onclick = () => window.open(b.link, '_blank');
                    shelf.appendChild(div);
                    currentW += w + 1; // +1 de margem
                }
            });
        }

        renderShelf();
    </script>
</body>
</html>
